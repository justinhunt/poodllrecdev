define(["jquery","core/log","filter_poodll/upskin_plain"],function(a,b,c){"use strict";return b.debug("Universal Uploader: initialising"),{config:null,clone:function(){return a.extend(!0,{},this)},init:function(a,b,d){this.config=b,d?this.upskin=d:(this.upskin=c.clone(),this.upskin.init(b,a,!1,!1)),this.upskin.initControls()},uploadBlob:function(a,b){this.uploadFile(a,b)},extractFilename:function(a){var b="success<filename>",c=a.indexOf(b);if(c<1)return!1;var d=a.indexOf("</filename>"),e=a.substring(c+b.length,d);return e},fetchFileExtension:function(a){var b="";switch(a){case"image/jpeg":b="jpg";break;case"image/png":b="png";break;case"audio/wav":b="wav";break;case"audio/ogg":b="ogg";break;case"video/quicktime":b="mov";break;case"audio/mpeg3":b="mp3";break;case"audio/webm":b="webm";break;case"audio/x-mpeg-3":b="mp3";break;case"audio/3gpp":b="3gpp";break;case"video/mpeg3":b="3gpp";break;case"video/mp4":b="mp4";break;case"video/webm":b="webm"}return b},pokeFilename:function(c,d){var e="";return"undefined"!=typeof d.config.updatecontrol&&""!==d.config.updatecontrol&&(e=a('[id="'+d.config.updatecontrol+'"]')),e.length<1&&(e=a('[id="'+d.config.updatecontrol+'"]',window.parent.document)),e.length>0?(e.get(0).value=c,e.trigger("change"),!0):(b.debug("upload failed #2"),d.upskin.showMessage(M.util.get_string("recui_uploaderror","filter_poodll")),!1)},alertRecorderSuccess:function(a){this.config.hasOwnProperty("onuploadsuccess")&&this.config.onuploadsuccess(a)},alertRecorderFailure:function(a){this.config.hasOwnProperty("onuploadfailure")&&this.config.onuploadfailure(a)},completeAfterProcessing:function(c,d,e){this.upskin.showMessage(M.util.get_string("recui_awaitingconversion","filter_poodll")),c.config.iframeembed&&(d=c.config.s3root+c.config.s3filename);var f={};f.type="awaitingprocessing",f.mediaurl=d,f.mediafilename=c.config.s3filename,f.s3root=c.config.s3root,f.id=c.config.id,f.updatecontrol=c.config.updatecontrol,c.config.transcribe&&(f.transcripturl=d+".txt",f.transcriptfilename=c.config.s3filename+".txt"),c.config.hermes.postMessage(f);var g=this;a.ajax({url:c.config.s3root+c.config.s3filename,method:"HEAD",cache:!1,error:function(){b.debug("403 errors are normal here, till the file arrives back from conversion"),setTimeout(function(){g.completeAfterProcessing(c,d,e+500)},e)},success:function(a,b,f){switch(f.status){case 200:g.doUploadCompleteCallback(c,d);break;default:setTimeout(function(){g.completeAfterProcessing(c,d,e+500)},e)}}})},doUploadCompleteCallback:function(a,b){a.config.iframeembed&&(b=a.config.s3root+a.config.s3filename);var c=new Array;if(c[0]=a.config.widgetid,c[1]="filesubmitted",c[2]=b,c[3]=a.config.updatecontrol,c[4]=a.config.s3filename,this.upskin.showMessage(M.util.get_string("recui_uploadsuccess","filter_poodll")),a.config.iframeembed){var d={};d.type="filesubmitted",d.mediaurl=a.config.s3root+a.config.s3filename,d.mediafilename=a.config.s3filename,d.s3root=a.config.s3root,d.id=a.config.id,d.updatecontrol=a.config.updatecontrol,a.config.transcribe&&(d.transcripturl=a.config.s3root+a.config.s3filename+".txt",d.transcriptfilename=a.config.s3filename+".txt"),a.config.hermes.postMessage(d)}else a.config.callbackjs&&""!=a.config.callbackjs?"function"==typeof a.config.callbackjs?a.config.callbackjs(c):this.executeFunctionByName(a.config.callbackjs,window,c):a.pokeFilename(b,a)},postProcessUpload:function(a,c){var d=a.currentTarget;if(4==d.readyState)if(c.upskin.deactivateProgressSession(),200==d.status){var e=c.config.filename;if(e||(e=c.extractFilename(d.responseText)),!e)return b.debug("upload failed #1"),void b.debug(d);c.config.iframeembed?this.completeAfterProcessing(c,e,1e3):this.doUploadCompleteCallback(c,e),this.alertRecorderSuccess(c.config.widgetid)}else b.debug("upload failed #3"),b.debug(d),c.upskin.showMessage(M.util.get_string("recui_uploaderror","filter_poodll")),this.alertRecorderFailure(c.config.widgetid)},uploadFile:function(a,b){var c=new XMLHttpRequest,d=this.config,e=this,f=this.fetchFileExtension(b);"undefined"==typeof d.iframeembed&&(d.iframeembed=!1);var g=d.using_s3;if(this.upskin.initProgressSession(c),this.upskin.showMessage(M.util.get_string("recui_uploading","filter_poodll")),c.onreadystatechange=function(a){g&&4===this.readyState&&(d.iframeembed?e.postprocess_uploadfromiframeembed(e,f):e.postprocess_s3_upload(e)),e.postProcessUpload(a,e)},g)c.open("put",d.posturl,!0),c.setRequestHeader("Content-Type","application/octet-stream"),c.send(a);else if(a instanceof Blob){var h=new window.FileReader;h.readAsDataURL(a),h.onloadend=function(){var a=h.result,b="datatype=uploadfile";b+="&paramone="+encodeURIComponent(a),b+="&paramtwo="+f,b+="&paramthree="+d.mediatype,b+="&requestid="+d.widgetid,b+="&contextid="+d.p2,b+="&component="+d.p3,b+="&filearea="+d.p4,b+="&itemid="+d.p5,c.open("POST",d.posturl,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.setRequestHeader("Cache-Control","no-cache"),c.send(b)}}else{var i="datatype=uploadfile";i+="&paramone="+encodeURIComponent(a),i+="&paramtwo="+f,i+="&paramthree="+d.mediatype,i+="&requestid="+d.widgetid,i+="&contextid="+d.p2,i+="&component="+d.p3,i+="&filearea="+d.p4,i+="&itemid="+d.p5,c.open("POST",d.posturl,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.setRequestHeader("Cache-Control","no-cache"),c.send(i)}},postprocess_uploadfromiframeembed:function(b,c){var d=b.config,e=new XMLHttpRequest,f=this;if(!d.transcode)switch(d.mediatype){case"audio":b.config.s3filename=d.s3filename.replace(".mp3","."+c),b.config.cloudfilename=b.config.s3filename;break;case"video":b.config.s3filename=d.s3filename.replace(".mp4","."+c)}e.onreadystatechange=function(){if(4===this.readyState)if(200!=e.status)f.upskin.showMessage("Post Process Upload from IframeEmbed Error:"+e.status),a("#"+f.config.widgetid+"_messages").show();else{var c=e.responseText,d=JSON.parse(c);if(d&&d.returnCode>0){var g={};g.type="error",g.code=d.returnCode,g.message=d.returnMessage,b.config.hermes.postMessage(g)}}};var g="wstoken="+d.wstoken+"&wsfunction=local_cpapi_postprocess_upload&moodlewsrestformat=json&mediatype="+d.mediatype+"&filename="+d.filename+"&ext="+c+"&parent="+d.parent+"&owner="+d.owner+"&region="+d.region+"&expiredays="+d.expiredays+"&transcode="+d.transcode,h=M.cfg.wwwroot+"/webservice/rest/server.php";e.open("POST",h,!0),e.setRequestHeader("Cache-Control","no-cache"),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.send(g)},postprocess_s3_upload:function(b){var c=b.config,d=new XMLHttpRequest,e=this;d.onreadystatechange=function(){4===this.readyState&&200!=d.status&&(e.upskin.showMessage("Post Process s3 Upload Error:"+d.status),a("#"+e.config.widgetid+"_messages").show())};var f="datatype=handles3upload";f+="&contextid="+c.p2,f+="&component="+c.p3,f+="&filearea="+c.p4,f+="&itemid="+c.p5,f+="&filename="+c.filename,f+="&mediatype="+c.mediatype,d.open("POST",M.cfg.wwwroot+"/filter/poodll/poodllfilelib.php",!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("Cache-Control","no-cache"),d.send(f)},executeFunctionByName:function(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++)b=b[d[f]];return b[e].call(this,c)},dataURItoBlob:function(a,b){for(var c=atob(a.split(",")[1]),d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);return new Blob([d],{type:b})},Output:function(a){this.upskin.showMessage(a)}}});